<script>
  let currentUser = {};
  let payrollDataTemp = [];
  let keranjangBelanja = [];
  let globalRiwayatData = [];
  let dataJualTemp = [];
  let dataBeliTemp = [];
  let keranjangBeli = [];
  let globalProdukList = [];
  let tempProductPOS = {};
  let globalModalObj;
  let onConfirmAction = null;
  const rupiah = (n) => new Intl.NumberFormat('id-ID', {style: 'currency', currency: 'IDR', minimumFractionDigits:0}).format(n);

window.onload = function() { 
      // 1. Setup Database
      google.script.run.setupDatabase(); 

      // 2. [FIX PENTING] Pindahkan semua Modal ke Body agar tidak tertutup layar gelap
      const modals = document.querySelectorAll('.modal');
      modals.forEach(m => document.body.appendChild(m));

      // 3. Init Modal Global
      initModal();
  };

  function initModal() {
     if(!globalModalObj) globalModalObj = new bootstrap.Modal(document.getElementById('globalModal'));
  }

  // 1. PENGGANTI ALERT (Hanya Tombol OK)
  function myAlert(title, message, type = 'info') {
     initModal();
     document.getElementById('globalModalTitle').innerText = title;
     document.getElementById('globalModalBody').innerText = message;
     document.getElementById('btn-cancel').classList.add('d-none'); // Sembunyikan tombol Batal
     
     const btnOk = document.getElementById('btn-confirm');
     btnOk.innerText = "OK";
     btnOk.onclick = () => globalModalObj.hide();

     // Styling Warna Header & Icon
     const header = document.getElementById('globalModalHeader');
     const icon = document.getElementById('globalModalIcon');
     header.className = 'modal-header text-white'; // Reset
     
     if(type === 'error') {
        header.classList.add('bg-danger');
        icon.innerText = 'error_outline';
        icon.style.color = '#dc3545';
        btnOk.className = 'btn btn-danger px-4';
     } else if (type === 'success') {
        header.classList.add('bg-success');
        icon.innerText = 'check_circle';
        icon.style.color = '#198754';
        btnOk.className = 'btn btn-success px-4';
     } else {
        header.classList.add('bg-primary');
        icon.innerText = 'info';
        icon.style.color = '#0d6efd';
        btnOk.className = 'btn btn-primary px-4';
     }

     globalModalObj.show();
  }

  // 2. PENGGANTI CONFIRM (Tombol Ya & Batal)
  function myConfirm(title, message, callback) {
     initModal();
     document.getElementById('globalModalTitle').innerText = title;
     document.getElementById('globalModalBody').innerText = message;
     document.getElementById('btn-cancel').classList.remove('d-none'); // Munculkan tombol Batal
     
     // Styling
     const header = document.getElementById('globalModalHeader');
     const icon = document.getElementById('globalModalIcon');
     header.className = 'modal-header text-white bg-warning'; // Warna kuning untuk warning
     icon.innerText = 'help_outline';
     icon.style.color = '#ffc107';

     const btnYes = document.getElementById('btn-confirm');
     btnYes.innerText = "YA, LANJUTKAN";
     btnYes.className = 'btn btn-warning fw-bold px-4';
     
     // Set Action saat klik YA
     btnYes.onclick = () => {
        globalModalObj.hide();
        if(callback) callback(); // Jalankan fungsi yang dikirim
     };

     globalModalObj.show();
  }
  
  // --- FUNGSI LOADING (ANIMASI) ---
  function loading(status) {
    const el = document.getElementById('loading-overlay');
    if(el) { // Cek jika elemen ada agar tidak error
        if(status) {
            el.classList.remove('d-none');
        } else {
            el.classList.add('d-none');
        }
    }
  }

function showPage(pageId) {
    // 1. Logika Ganti Halaman (UI) - Sembunyikan semua, munculkan yang dipilih
    document.querySelectorAll('.page-section').forEach(el => el.classList.add('d-none'));
    const targetPage = document.getElementById('page-' + pageId);
    if(targetPage) targetPage.classList.remove('d-none');
    
    // 2. Update Menu Navigasi (Active State)
    document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
    const navEl = document.getElementById('nav-' + pageId);
    
    // Khusus Submenu Riwayat (agar induknya tetap aktif jika mau)
    if(pageId === 'riwayat-jual' || pageId === 'riwayat-beli') {
        // Opsional: Buka accordion riwayat jika tertutup
        const collapseRiwayat = document.getElementById('submenu-riwayat');
        if(collapseRiwayat && !collapseRiwayat.classList.contains('show')) {
            new bootstrap.Collapse(collapseRiwayat, { show: true });
        }
    } else {
        if(navEl) navEl.classList.add('active');
    }

    // 3. LOGIKA MUAT DATA OTOMATIS (AUTO LOAD)
    
    // A. Dashboard & Laporan
    if(pageId === 'dashboard' || pageId === 'laporan') loadDashboard();
    
    // B. Produk & Kasir
    if(pageId === 'produk' || pageId === 'kasir') {
        loadProduk();
        if(pageId === 'kasir') loadPelangganDropdown();
    }
    
    // C. Keuangan & Pembelian
    if(pageId === 'keuangan') loadKeuangan();
    if(pageId === 'pembelian') loadPembelianData();
    
    // D. Payroll
    if(pageId === 'payroll') switchTab('karyawan');
    
    // E. Pelanggan
    if(pageId === 'pelanggan') loadPelanggan();

    // --- BAGIAN PENTING: RIWAYAT AUTO LOAD & DATE ---
    if(pageId === 'riwayat-jual') {
        setAutoDate('jual'); // Isi tanggal 1 s/d hari ini
        loadRiwayatJual();   // Langsung ambil data
    }

    if(pageId === 'riwayat-beli') {
        setAutoDate('beli'); // Isi tanggal 1 s/d hari ini
        loadRiwayatBeli();   // Langsung ambil data
    }
    
    if(pageId === 'riwayat-piutang') loadPiutang();
}

function handleLogin() {
  const u = document.getElementById('username').value;
  const p = document.getElementById('password').value;
  
  if(!u || !p) return myAlert('Isian Kosong', 'Harap isi username & password!', 'warning');

  loading(true); // Layar Putih Nyala

  google.script.run
    .withSuccessHandler(function(res) {
        loading(false); // MATIKAN Layar Putih (Wajib di sini)
        
        setTimeout(function() {
            if(res.status === 'success') {
               currentUser = res;
               document.getElementById('login-section').classList.add('d-none');
               document.getElementById('main-app').classList.remove('d-none');
               document.getElementById('display-user').innerText = res.nama;
               showPage('dashboard');
            } else {
               // Jika salah password, popup akan muncul SEKARANG
               myAlert('Gagal Masuk', 'Username atau Password salah!', 'error');
            }
        }, 300); // Jeda 0.3 detik agar transisi mulus
    })
    .withFailureHandler(function(e) {
        loading(false); // MATIKAN Layar Putih jika error
        setTimeout(function() { myAlert('Error Server', 'Gagal terhubung: ' + e, 'error'); }, 300);
    })
    .loginUser(u, p);
}
  
  function logout() { location.reload(); }

  // --- DASHBOARD ---
  function loadDashboard() {
    loading(true);
    google.script.run.withSuccessHandler(s => {
      loading(false);
      document.getElementById('dash-income').innerText = rupiah(s.income);
      document.getElementById('dash-expense').innerText = rupiah(s.expense);
      document.getElementById('dash-net').innerText = rupiah(s.net);
      document.getElementById('lap-net').innerText = rupiah(s.net);
    }).getDashboardStats();
  }

  // --- PRODUK & KASIR ---
function loadProduk() {
    loading(true);
    google.script.run.withSuccessHandler(data => {
      loading(false);
      globalProdukList = data; // Simpan ke global
      
      // 1. Render Grid Kasir (POS)
      renderProdukGrid(data);  
      
      // 2. Render Tabel Admin (YANG HILANG SEBELUMNYA)
      const tb = document.querySelector('#tabel-produk tbody');
      if(tb) {
         tb.innerHTML = ''; // Kosongkan tabel dulu
         data.forEach(r => {
            // Mapping Index: 0:ID, 1:Nama, 2:Jual, 3:Beli, 4:Stok Isi, 5:Stok Kosong
            tb.innerHTML += `
              <tr>
                <td class="fw-bold">${r[1]}</td>
                <td>${rupiah(r[2])}</td>
                <td>${rupiah(r[3])}</td>
                <td class="text-center">${r[4]}</td>
                <td class="text-center">${r[5]}</td>
                <td>
                   <button class="btn btn-sm btn-light text-danger border" onclick="hapusProduk('${r[1]}')">
                     <i class="material-icons" style="font-size:14px">delete</i>
                   </button>
                </td>
              </tr>
            `;
         });
      }

      // 3. Update Dropdown di halaman Stok Masuk (Beli)
      const selB = document.getElementById('beli-produk');
      if(selB) {
         selB.innerHTML = '<option value="">--Pilih--</option>';
         data.forEach(p => selB.innerHTML += `<option value="${p[1]}" data-buy="${p[3]}">${p[1]}</option>`);
      }

    }).getData('PRODUK');
}

// Fungsi Render Grid
function renderProdukGrid(data) {
   const container = document.getElementById('pos-grid-container');
   if(!container) return;
   
   container.innerHTML = '';

   data.forEach(p => {
      // Index Data: 
      // 0:ID, 1:Nama, 2:Jual, 3:Beli, 4:Isi, 5:Kosong, 6:SKU, 7:Kode, 8:Gambar
      
      let nama = p[1];
      let harga = p[2];
      let stok = Number(p[4]);
      let linkGambar = p[8]; // Ambil link gambar dari kolom index 8

      // Logika Tampilan Gambar
      let gambarHtml = '';
      if(linkGambar && linkGambar.length > 5) {
          // Jika ada link gambar, pakai tag IMG
          gambarHtml = `<img src="${linkGambar}" class="mb-2 rounded" style="width: 100%; height: 100px; object-fit: contain;">`;
      } else {
          // Jika tidak ada, pakai Icon default
          gambarHtml = `
           <div class="product-icon mx-auto mb-2">
              <i class="material-icons">propane</i> 
           </div>`;
      }

      let disabledClass = stok <= 0 ? 'opacity-50 grayscale' : '';
      let badgeStok = stok > 0 
          ? `<span class="badge bg-success-subtle text-success border border-success-subtle rounded-pill" style="font-size:10px;">Stok: ${stok}</span>` 
          : `<span class="badge bg-danger text-white rounded-pill">Habis</span>`;
      
      // Tampilkan SKU/Kode kecil di atas nama (Opsional)
      let kodeHtml = p[6] ? `<small class="text-muted d-block mb-1" style="font-size:10px;">${p[6]}</small>` : '';

      container.innerHTML += `
      <div class="col-6 col-md-4 col-lg-3">
         <div class="card h-100 product-card border-0 shadow-sm ${disabledClass}" 
              onclick="klikProdukPOS('${nama}', ${harga}, ${stok})">
            <div class="card-body text-center p-2">
               ${gambarHtml}
               ${kodeHtml}
               <h6 class="fw-bold text-dark mb-1 text-truncate" title="${nama}" style="font-size: 0.9rem;">${nama}</h6>
               <div class="text-primary fw-bold mb-2 small">${rupiah(harga)}</div>
               ${badgeStok}
            </div>
         </div>
      </div>
      `;
   });
}

// 1. FUNGSI SAAT KARTU PRODUK DIKLIK (GANTI FUNGSI LAMA DENGAN INI)
function klikProdukPOS(nama, harga, stok) {
    if(stok <= 0) return myAlert('Stok Habis', 'Produk ini sedang kosong.', 'error');

    // Simpan data produk ke variabel sementara
    tempProductPOS = { nama, harga, stok };

    // Siapkan Tampilan Modal
    document.getElementById('qty-modal-title').innerText = nama;
    const inputQty = document.getElementById('input-qty-pos');
    inputQty.value = 1; // Default angka 1
    document.getElementById('qty-msg-error').classList.add('d-none'); // Sembunyikan error

    // Buka Modal
    const myModal = new bootstrap.Modal(document.getElementById('modalInputQty'));
    myModal.show();

    // Auto Focus: Supaya user bisa langsung ketik angka tanpa klik inputnya dulu
    setTimeout(() => {
        inputQty.focus();
        inputQty.select(); 
    }, 500);
}

// 2. FUNGSI TOMBOL "ENTER" DI MODAL
function submitQtyPOS() {
    const qtyInput = document.getElementById('input-qty-pos');
    const qty = Number(qtyInput.value);
    const stok = tempProductPOS.stok;
    const nama = tempProductPOS.nama;
    const harga = tempProductPOS.harga;

    // Validasi Input
    if(qty <= 0) {
        qtyInput.focus();
        return;
    }

    // Cek Mode Transaksi (Refill / Baru)
    let mode = document.querySelector('input[name="posMode"]:checked').value;
    
    // Cek apakah barang sudah ada di keranjang untuk menghitung total stok yg dibutuhkan
    let index = keranjangBelanja.findIndex(item => item.produkNama === nama && item.tipe === mode);
    let currentQtyInCart = (index !== -1) ? keranjangBelanja[index].qty : 0;

    // Validasi Stok (Input Baru + Yang Sudah Ada di Keranjang > Stok Tersedia?)
    if((currentQtyInCart + qty) > stok) {
        document.getElementById('qty-msg-error').innerText = `Sisa stok hanya ${stok - currentQtyInCart}`;
        document.getElementById('qty-msg-error').classList.remove('d-none');
        return;
    }

    // PROSES MASUK KERANJANG
    if(index !== -1) {
       // Update Qty jika sudah ada
       keranjangBelanja[index].qty += qty;
       keranjangBelanja[index].total = keranjangBelanja[index].qty * harga;
    } else {
       // Item Baru
       keranjangBelanja.push({
          produkNama: nama,
          qty: qty,
          tipe: mode,
          hargaSatuan: harga,
          total: qty * harga
       });
    }
    
    // Tutup Modal & Refresh Tampilan
    bootstrap.Modal.getInstance(document.getElementById('modalInputQty')).hide();
    renderKeranjangPOS();
}

// 3. TAMBAHAN: Agar bisa tekan tombol "ENTER" di keyboard saat input qty
document.getElementById('input-qty-pos').addEventListener("keypress", function(event) {
  if (event.key === "Enter") {
    event.preventDefault();
    submitQtyPOS();
  }
});

// Fungsi Render Keranjang Kanan (Versi Tabel Minimalis)
function renderKeranjangPOS() {
   const tbody = document.getElementById('pos-cart-body');
   const emptyMsg = document.getElementById('empty-cart-msg');
   
   if(keranjangBelanja.length === 0) {
      tbody.innerHTML = '';
      emptyMsg.classList.remove('d-none');
      document.getElementById('pos-subtotal').innerText = 'Rp 0';
      document.getElementById('pos-grand-total').innerText = 'Rp 0';
      document.getElementById('cart-count-badge').innerText = '0 Item';
      return;
   }

   emptyMsg.classList.add('d-none');
   tbody.innerHTML = '';
   let grandTotal = 0;
   let totalItem = 0;

   keranjangBelanja.forEach((item, index) => {
      grandTotal += item.total;
      totalItem += item.qty;
      
      let badgeTipe = item.tipe.includes('Refill') ? '<span class="text-warning" style="font-size:10px">● Refill</span>' : '<span class="text-success" style="font-size:10px">● Baru</span>';

      tbody.innerHTML += `
      <tr>
         <td class="ps-4">
            <div class="fw-bold text-dark" style="font-size: 14px;">${item.produkNama}</div>
            ${badgeTipe}
            <div class="text-muted small">${rupiah(item.hargaSatuan)} x ${item.qty}</div>
         </td>
         <td class="text-end pe-3">
            <div class="fw-bold mb-1">${rupiah(item.total)}</div>
            <button class="btn btn-sm btn-light text-danger py-0 px-2 border" onclick="hapusItemKeranjang(${index}); renderKeranjangPOS();">
               <i class="material-icons" style="font-size:14px">close</i>
            </button>
         </td>
      </tr>
      `;
   });

   document.getElementById('pos-subtotal').innerText = rupiah(grandTotal);
   document.getElementById('pos-grand-total').innerText = rupiah(grandTotal);
   document.getElementById('cart-count-badge').innerText = totalItem + ' Item';
}

// Fungsi Pencarian Grid
function filterProdukGrid() {
   const keyword = document.getElementById('cari-produk-pos').value.toLowerCase();
   const filtered = globalProdukList.filter(p => p[1].toLowerCase().includes(keyword));
   renderProdukGrid(filtered);
}

// Override fungsi resetKeranjang agar compatible dengan POS
let originalReset = resetKeranjang;
resetKeranjang = function() {
    keranjangBelanja = [];
    renderKeranjangPOS();
}

function simpanProduk() {
    const fileInput = document.getElementById('prod-file-gambar');
    const file = fileInput.files[0];
    
    // Ambil data form lainnya
    const dataForm = {
        sku: document.getElementById('prod-sku').value,
        kode: document.getElementById('prod-kode').value,
        nama: document.getElementById('prod-nama').value, 
        hargaJual: document.getElementById('prod-jual').value, 
        hargaBeli: document.getElementById('prod-beli').value, 
        stokIsi: document.getElementById('prod-isi').value, 
        stokKosong: document.getElementById('prod-kosong').value,
        gambar: '' // Nanti diisi
    };

    // Fungsi untuk mengirim data ke Google Script
    const kirimData = (finalData) => {
        loading(true);
        google.script.run.withSuccessHandler(() => { 
            loading(false);
            document.getElementById('loading-upload')?.classList.add('d-none');
            
            // [TAMBAHAN] Reset Preview & Input File
            document.getElementById('img-preview').classList.add('d-none');
            document.getElementById('img-preview').src = '';
            
            bootstrap.Modal.getInstance(document.getElementById('modalProduk')).hide(); 
            loadProduk(); 
            document.querySelectorAll('#modalProduk input').forEach(i => i.value = '');
        }).tambahProduk(dataForm);
    };

    // LOGIKA UPLOAD GAMBAR
    if (file) {
        // Validasi ukuran (misal maks 2MB agar tidak berat)
        if (file.size > 2 * 1024 * 1024) {
            return myAlert('File Terlalu Besar', 'Maksimal ukuran gambar 2MB', 'error');
        }

        document.getElementById('loading-upload').classList.remove('d-none'); // Tampilkan loading teks
        
        const reader = new FileReader();
        reader.onload = function(e) {
            // Isi properti gambar dengan data file (base64)
            dataForm.gambar = {
                data: e.target.result.split(',')[1], // Ambil base64-nya saja
                mimeType: file.type,
                fileName: 'PROD-' + Date.now() // Nama file unik
            };
            kirimData(dataForm); // Kirim setelah file terbaca
        };
        reader.readAsDataURL(file);
    } else {
        // Jika tidak ada gambar, langsung kirim data kosong
        dataForm.gambar = null;
        kirimData(dataForm);
    }
}

// [TAMBAHAN] Fungsi untuk Preview Gambar
function tampilkanPreview(input) {
    const preview = document.getElementById('img-preview');
    
    if (input.files && input.files[0]) {
        const reader = new FileReader();

        reader.onload = function(e) {
            preview.src = e.target.result; // Isi sumber gambar dengan hasil bacaan file
            preview.classList.remove('d-none'); // Munculkan gambar
        }

        reader.readAsDataURL(input.files[0]); // Mulai membaca file
    } else {
        // Jika user batal milih file, sembunyikan lagi gambarnya
        preview.src = '';
        preview.classList.add('d-none');
    }
}

function hapusProduk(n) { 
      myConfirm('Hapus Produk', `Yakin hapus produk ${n}?`, () => {
          loading(true);
          google.script.run.withSuccessHandler(() => {
              loading(false);
              loadProduk();
              myAlert('Info', 'Produk dihapus', 'success');
          }).hapusProduk(n);
      });
  }
  function updateHargaJual() {
    const sel = document.getElementById('kasir-produk');
    const price = sel.options[sel.selectedIndex]?.getAttribute('data-price') || 0;
    const qty = document.getElementById('kasir-qty').value;
    document.getElementById('kasir-total').innerText = rupiah(price * qty);
  }

  function hapusItemKeranjang(index) {
      // 1. Hapus item dari array data
      keranjangBelanja.splice(index, 1);
      
      // 2. Render ulang tampilan menggunakan fungsi POS yang baru
      renderKeranjangPOS(); 
  }

  function resetKeranjang() {
    keranjangBelanja = [];
    renderKeranjang();
  }

function prosesBayarFinal() {
    if(keranjangBelanja.length === 0) return myAlert('Keranjang Kosong', 'Belum ada barang yang diinput.', 'error');
    
    // Cek Tabung Kosong
    let butuhTabungKosong = 0;
    keranjangBelanja.forEach(k => { if(k.tipe === 'Tukar (Refill)') butuhTabungKosong += k.qty; });

const eksekusiBayar = () => {
    // PERBAIKAN: Gunakan ID 'pos-grand-total' yang sesuai dengan HTML
    const totalBayarStr = document.getElementById('pos-grand-total').innerText; 
    
    myConfirm('Konfirmasi Pembayaran', `Total Transaksi: ${totalBayarStr}\n\nSimpan data ini?`, () => {
            
            // AMBIL METODE PEMBAYARAN DARI HTML
            // AMBIL DATA
                const metodeDipilih = document.getElementById('pos-metode-bayar').value;
                const tglJatuhTempo = document.getElementById('pos-jatuh-tempo').value; // Ambil tanggal

                // Validasi Hutang Wajib Isi Tanggal
                if(metodeDipilih === 'Hutang' && !tglJatuhTempo) {
                    return myAlert('Error', 'Untuk Hutang, Tanggal Jatuh Tempo wajib diisi!', 'warning');
                }

                const payload = {
                    pelanggan: document.getElementById('kasir-pelanggan').value,
                    kasir: currentUser.nama || 'Admin',
                    metode: metodeDipilih,
                    jatuhTempo: (metodeDipilih === 'Hutang') ? tglJatuhTempo : '', // Kirim tanggal
                    items: keranjangBelanja
                };

            loading(true);
        google.script.run.withSuccessHandler(res => {
           loading(false);
           myAlert('Berhasil', res, 'success'); 
           resetKeranjang();
           loadProduk(); 
        }).withFailureHandler(err => {
           loading(false);
           myAlert('Gagal', err, 'error');
        }).simpanTransaksiBulk(payload);

    });
};

    // --- LOGIC PENGECEKAN TABUNG ---
    if(butuhTabungKosong > 0) {
       // Konfirmasi Pertama: Tabung Kosong
       myConfirm('Cek Fisik Tabung', `Transaksi ini ada Refill.\nApakah Anda sudah menerima ${butuhTabungKosong} Tabung Kosong dari pelanggan?`, () => {
           
           // --- PERBAIKAN DI SINI: PAKAI SETTIMEOUT ---
           // Beri jeda 500ms (0.5 detik) agar modal pertama nutup dulu dengan mulus
           setTimeout(() => {
               eksekusiBayar();
           }, 500); 
           // -------------------------------------------

       });
    } else {
       // Jika tidak butuh tabung, langsung bayar
       eksekusiBayar();
    }
  }

  function loadNotifHutang() {
    google.script.run.withSuccessHandler(jumlah => {
        const badge = document.getElementById('notif-badge');
        if(jumlah > 0) {
            badge.innerText = jumlah;
            badge.classList.remove('d-none');
        } else {
            badge.classList.add('d-none');
        }
    }).getJumlahJatuhTempo();
}

// Panggil fungsi ini di window.onload agar saat buka aplikasi langsung cek
// Tambahkan di dalam window.onload = function() { ... loadNotifHutang(); ... }

function cekNotifHutang() {
    // Nanti diarahkan ke halaman khusus hutang (Sementara alert dulu)
    myAlert('Info Tagihan', 'Silakan buka menu Riwayat > Piutang untuk melihat detail penagihan.', 'info');
}

  function updateHargaBeli() {
    const sel = document.getElementById('beli-produk');
    const price = sel.options[sel.selectedIndex]?.getAttribute('data-buy') || 0;
    const qty = document.getElementById('beli-qty').value;
    
    // Auto isi harga beli jika kosong/belum diubah
    if(document.getElementById('beli-harga').value == '' || document.getElementById('beli-harga').value == 0) {
        document.getElementById('beli-harga').value = price;
    }
    
    const finalPrice = document.getElementById('beli-harga').value;
    document.getElementById('beli-subtotal-label').innerText = rupiah(finalPrice * qty);
  }

  function tambahKeKeranjangBeli() {
      const prod = document.getElementById('beli-produk').value;
      const qty = Number(document.getElementById('beli-qty').value);
      const harga = Number(document.getElementById('beli-harga').value);
      const isTukar = document.getElementById('beli-tukar').checked;
      
      if(!prod) return myAlert('Error', 'Pilih produk dulu!', 'error');
      if(qty <= 0) return myAlert('Error', 'Jumlah minimal 1', 'error');

      // Masukkan ke array
      keranjangBeli.push({
          produk: prod,
          qty: qty,
          hargaSatuan: harga,
          isTukar: isTukar,
          total: qty * harga
      });

      renderKeranjangBeli();
  }

  function renderKeranjangBeli() {
      const tb = document.querySelector('#tabel-keranjang-beli tbody');
      tb.innerHTML = '';
      let grandTotal = 0;

      keranjangBeli.forEach((item, index) => {
          grandTotal += item.total;
          let badgeTukar = item.isTukar ? '<span class="badge bg-warning text-dark" style="font-size:10px">Tukar Tabung</span>' : '<span class="badge bg-success" style="font-size:10px">Tabung Baru</span>';
          
          tb.innerHTML += `
            <tr>
                <td class="fw-bold">${item.produk}</td>
                <td>${badgeTukar}</td>
                <td>${item.qty}</td>
                <td>${rupiah(item.total)}</td>
                <td><button class="btn btn-sm btn-light text-danger" onclick="hapusItemBeli(${index})"><i class="material-icons" style="font-size:16px">delete</i></button></td>
            </tr>
          `;
      });

      document.getElementById('label-grand-total-beli').innerText = rupiah(grandTotal);
  }

  function hapusItemBeli(index) {
      keranjangBeli.splice(index, 1);
      renderKeranjangBeli();
  }

  function resetKeranjangBeli() {
      keranjangBeli = [];
      renderKeranjangBeli();
  }

  function prosesBeliFinal() {
      const supplier = document.getElementById('beli-supplier').value;
      
      if(!supplier) return myAlert('Error', 'Pilih Supplier dulu!', 'error');
      if(keranjangBeli.length === 0) return myAlert('Error', 'List belanja masih kosong', 'error');

      // Hitung Grand Total Angka
      let grandTotal = keranjangBeli.reduce((acc, item) => acc + item.total, 0);

      myConfirm('Simpan Pembelian', `Total Tagihan: ${rupiah(grandTotal)}\nSupplier: ${supplier}\n\nLanjutkan simpan stok?`, () => {
          
          const payload = {
              supplier: supplier,
              items: keranjangBeli,
              grandTotal: grandTotal
          };

          loading(true);
          google.script.run.withSuccessHandler(res => {
              loading(false);
              myAlert('Sukses', res, 'success');
              resetKeranjangBeli();
              loadProduk(); // Refresh stok di tabel produk
          }).simpanPembelianBulk(payload);
      });
  }

// --- javascript ---

  // --- RIWAYAT TRANSAKSI ---

function loadRiwayatData() {
    loading(true);
    google.script.run
      .withFailureHandler(err => {
         loading(false);
         myAlert('Error', err, 'error');
      })
      .withSuccessHandler(data => {
         loading(false);
         globalRiwayatData = data; // Simpan ke variabel global

         const tb = document.querySelector('#tabel-riwayat tbody');
         const thead = document.querySelector('#tabel-riwayat thead tr');
         
         // Update Header Tabel Sesuai Permintaan
         thead.innerHTML = `
            <th>ID & Waktu</th>
            <th>Pelanggan</th>
            <th>Total</th>
            <th>Aksi</th>
         `;

         tb.innerHTML = '';
         
         if (!data || data.length === 0) {
            tb.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Belum ada data transaksi.</td></tr>';
            return;
         }
  
         data.forEach((trx, index) => {
            let tgl = '-';
            try { tgl = new Date(trx.waktu).toLocaleString('id-ID'); } catch(e) {}
            
            // Render Baris (Row)
            tb.innerHTML += `
              <tr>
                 <td>
                    <span class="fw-bold text-primary">${trx.id}</span><br>
                    <small class="text-muted">${tgl}</small>
                 </td>
                 <td>${trx.pelanggan} <br> <small class="text-muted">Kasir: ${trx.kasir}</small></td>
                 <td class="fw-bold">${rupiah(trx.totalBayar)}</td>
                 <td>
                   <button class="btn btn-sm btn-info text-white" onclick="viewDetail(${index})">
                      <i class="material-icons align-middle" style="font-size:16px">visibility</i> View
                   </button>
                 </td>
              </tr>
            `;
         });
      }).getRiwayatTransaksi();
}

// Fungsi untuk Membuka Modal Detail
function viewDetail(index) {
    const trx = globalRiwayatData[index]; // Ambil data dari variabel global berdasarkan index
    if(!trx) return;

    // Isi Info Header Modal
    document.getElementById('det-id').innerText = trx.id;
    document.getElementById('det-pelanggan').innerText = trx.pelanggan;
    document.getElementById('det-waktu').innerText = new Date(trx.waktu).toLocaleString('id-ID');
    
    // Isi Tabel Detail Item
    const tb = document.querySelector('#tabel-detail-trx tbody');
    tb.innerHTML = '';
    
    trx.items.forEach(item => {
        tb.innerHTML += `
            <tr>
                <td>${item.produk} <br> <small class="text-muted">${item.tipe}</small></td>
                <td class="text-center">${item.qty}</td>
                <td class="text-end">${rupiah(item.hargaTotal)}</td>
            </tr>
        `;
    });

    // Isi Grand Total di Bawah Modal
    document.getElementById('det-total').innerText = rupiah(trx.totalBayar);

    // Tampilkan Modal
    new bootstrap.Modal(document.getElementById('modalDetailTrx')).show();
}

  function aksiRetur(id, produk, qty, tipe) {
     // Menggunakan myConfirm (Modal) agar konsisten dengan UI
     myConfirm('Retur Barang', `Yakin ingin membatalkan/retur item ini?\n\n${produk} (${qty})\n\nStok akan dikembalikan ke sistem.`, () => {
        loading(true);
        google.script.run.withSuccessHandler(res => {
           loading(false);
           myAlert('Sukses', res, 'success');
           loadRiwayatData();
           loadProduk(); // Update stok di tabel produk
        }).prosesRetur(id, produk, qty, tipe, 'PARTIAL');
     });
  }

  function filterRiwayat() {
    const k = document.getElementById('cari-trx').value.toLowerCase();
    document.querySelectorAll('#tabel-riwayat tbody tr').forEach(tr => {
       if(tr.innerText.toLowerCase().includes(k)) {
          tr.style.display = '';
       } else {
          tr.style.display = 'none';
       }
    });
  }

  function aksiRetur(id, produk, qty, tipe) {
     if(confirm(`Yakin ingin meretur/membatalkan item ini?\n\n${produk} (${qty})\n\nStok akan dikembalikan.`)) {
        loading(true);
        google.script.run.withSuccessHandler(res => {
           loading(false);
           alert(res);
           loadRiwayatData();
           loadProduk(); // Update stok
        }).prosesRetur(id, produk, qty, tipe, 'PARTIAL');
     }
  }

  function filterRiwayat() {
    const k = document.getElementById('cari-trx').value.toLowerCase();
    document.querySelectorAll('#tabel-riwayat tbody tr').forEach(tr => {
       tr.style.display = tr.innerText.toLowerCase().includes(k) ? '' : 'none';
    });
  }

  // 2. FUNGSI LOAD DATA
function loadRiwayatJual() {
   loading(true);
   google.script.run.withSuccessHandler(data => {
      loading(false);
      dataJualTemp = data; // Simpan ke global
      renderTabelRiwayat('tabel-riwayat-jual', data, 'JUAL');
   }).getRiwayatTransaksi(); // Fungsi lama (sudah diupdate grouping)
}

function loadRiwayatBeli() {
   loading(true);
   google.script.run.withSuccessHandler(data => {
      loading(false);
      dataBeliTemp = data; // Simpan ke global
      renderTabelRiwayat('tabel-riwayat-beli', data, 'BELI');
   }).getRiwayatPembelian(); // Fungsi baru di Code.gs
}

// 3. RENDER TABEL GENERIK
// --- LOGIC RENDER & FILTER RIWAYAT YANG DIPERBAIKI ---

// 1. UPDATE FUNGSI RENDER TABEL (Agar menyimpan Data Waktu)
function renderTabelRiwayat(tableId, data, tipe) {
   const tb = document.querySelector(`#${tableId} tbody`);
   tb.innerHTML = '';

   if(!data || data.length === 0) { 
      tb.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-muted">Belum ada data transaksi.</td></tr>'; 
      return;
   }

   data.forEach((trx, index) => {
      // Parsing Tanggal
      let dateObj = new Date(trx.waktu);
      let tglStr = dateObj.toLocaleString('id-ID');
      let timestamp = dateObj.getTime(); // Waktu dalam milidetik (PENTING UNTUK FILTER)

      // Kita simpan timestamp di atribut data-ts pada baris <tr>
      tb.innerHTML += `
        <tr data-ts="${timestamp}"> 
           <td>
              <span class="fw-bold text-primary" style="font-size:0.9rem">${trx.id}</span><br>
              <small class="text-muted" style="font-size:0.8rem">${tglStr}</small>
           </td>
           <td>
              <span class="fw-bold text-dark">${trx.pelanggan}</span>
              ${trx.kasir ? '<br><small class="text-muted">Kasir: '+trx.kasir+'</small>' : ''}
           </td>
           <td class="fw-bold">${rupiah(trx.totalBayar)}</td>
           <td>
             <button class="btn btn-sm btn-info text-white rounded-pill px-3" onclick="viewDetailTrx('${tipe}', ${index})">
               <i class="material-icons align-middle" style="font-size:14px">visibility</i> View
             </button>
           </td>
        </tr>`;
   });
}

// 2. FUNGSI FILTER UTAMA (Cari Text + Tanggal)
function terapkanFilter(tipe) {
    let tableId, inputStart, inputEnd, inputText;

    // Tentukan ID elemen berdasarkan Tipe (JUAL / BELI)
    if (tipe === 'JUAL') {
        tableId = 'tabel-riwayat-jual';
        inputStart = 'filter-jual-start';
        inputEnd = 'filter-jual-end';
        inputText = 'filter-jual-text';
    } else {
        tableId = 'tabel-riwayat-beli';
        inputStart = 'filter-beli-start';
        inputEnd = 'filter-beli-end';
        inputText = 'filter-beli-text';
    }

    // Ambil Nilai dari Input
    const keyword = document.getElementById(inputText).value.toLowerCase();
    const startDateVal = document.getElementById(inputStart).value;
    const endDateVal = document.getElementById(inputEnd).value;

    // Konversi tanggal filter ke Timestamp (00:00:00 dan 23:59:59)
    let startTs = startDateVal ? new Date(startDateVal).setHours(0,0,0,0) : 0;
    let endTs = endDateVal ? new Date(endDateVal).setHours(23,59,59,999) : 9999999999999; 

    // Loop semua baris di tabel
    const rows = document.querySelectorAll(`#${tableId} tbody tr`);
    let foundCount = 0;

    rows.forEach(row => {
        // Ambil data dari baris
        const textContent = row.innerText.toLowerCase();
        const rowTs = Number(row.getAttribute('data-ts')); // Ambil timestamp tersembunyi

        // Cek Logika Filter
        const matchText = textContent.includes(keyword);
        const matchDate = rowTs >= startTs && rowTs <= endTs;

        // Tampilkan jika Text COCOK -DAN- Tanggal MASUK RANGE
        if (matchText && matchDate) {
            row.style.display = '';
            foundCount++;
        } else {
            row.style.display = 'none';
        }
    });

    if(foundCount === 0) {
       // Opsional: Tampilkan pesan jika tidak ada hasil
       // myAlert('Info', 'Data tidak ditemukan dengan filter tersebut.');
    }
}

// Tambahkan Event Listener agar menekan ENTER di kolom pencarian langsung memfilter
document.getElementById('filter-jual-text')?.addEventListener('keyup', function(e) {
    if(e.key === 'Enter') terapkanFilter('JUAL');
    else terapkanFilter('JUAL'); // Live search saat mengetik
});

document.getElementById('filter-beli-text')?.addEventListener('keyup', function(e) {
    if(e.key === 'Enter') terapkanFilter('BELI');
    else terapkanFilter('BELI'); // Live search saat mengetik
});

// 4. VIEW DETAIL & TOMBOL RETUR
function viewDetailTrx(tipe, index) {
   const data = tipe === 'JUAL' ? dataJualTemp : dataBeliTemp;
   const trx = data[index];
   
   // Isi Modal Detail (Reuse modal yang sudah ada)
   document.getElementById('det-id').innerText = trx.id;
   document.getElementById('det-pelanggan').innerText = trx.pelanggan;
   document.getElementById('det-waktu').innerText = new Date(trx.waktu).toLocaleString();
   document.getElementById('det-total').innerText = rupiah(trx.totalBayar);
   
   const tb = document.querySelector('#tabel-detail-trx tbody');
   tb.innerHTML = '';
   trx.items.forEach(item => {
       tb.innerHTML += `<tr><td>${item.produk}</td><td class="text-center">${item.qty}</td><td class="text-end">${rupiah(item.hargaTotal)}</td></tr>`;
   });

   // PERUBAHAN: Tambahkan Tombol Retur di Footer Modal Detail secara dinamis
   const footer = document.querySelector('#modalDetailTrx .modal-footer');
   // Reset footer dulu
   footer.innerHTML = `<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>`;
   
   // Tambah tombol RETUR
   const btnRetur = document.createElement('button');
   btnRetur.className = 'btn btn-danger ms-2';
   btnRetur.innerText = 'RETUR / BATAL';
   btnRetur.onclick = () => {
       // Tutup modal detail, buka modal form retur
       bootstrap.Modal.getInstance(document.getElementById('modalDetailTrx')).hide();
       bukaFormRetur(trx, tipe);
   };
   footer.appendChild(btnRetur);

   new bootstrap.Modal(document.getElementById('modalDetailTrx')).show();
}

// 5. BUKA FORM RETUR (Baru)
function bukaFormRetur(trx, tipe) {
    document.getElementById('retur-id-trx').value = trx.id;
    document.getElementById('retur-jenis-trx').value = tipe;
    document.getElementById('check-retur-semua').checked = false;
    document.getElementById('retur-alasan').value = '';
    
    const container = document.getElementById('container-retur-items');
    container.innerHTML = '';

    trx.items.forEach((item, idx) => {
        // Hitung harga satuan kasar untuk referensi refund
        let hargaSatuan = item.hargaTotal / item.qty;
        
        container.innerHTML += `
           <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2 item-retur-row">
              <div style="flex:1">
                 <small class="fw-bold">${item.produk}</small><br>
                 <small class="text-muted">Dibeli: ${item.qty} | ${item.tipe || ''}</small>
                 <input type="hidden" class="data-produk" value="${item.produk}">
                 <input type="hidden" class="data-tipe" value="${item.tipe || ''}">
                 <input type="hidden" class="data-harga" value="${hargaSatuan}">
                 <input type="hidden" class="data-qty-asal" value="${item.qty}">
              </div>
              <div style="width: 100px;">
                 <input type="number" class="form-control form-control-sm input-qty-retur" 
                        placeholder="0" min="0" max="${item.qty}">
              </div>
           </div>
        `;
    });
    
    new bootstrap.Modal(document.getElementById('modalFormRetur')).show();
}

// 6. TOGGLE RETUR SEMUA
function toggleReturSemua() {
    const isChecked = document.getElementById('check-retur-semua').checked;
    const inputs = document.querySelectorAll('.input-qty-retur');
    const rows = document.querySelectorAll('.item-retur-row');
    
    inputs.forEach((input, idx) => {
        if(isChecked) {
            // Isi dengan qty maksimal (qty beli)
            const qtyAsal = rows[idx].querySelector('.data-qty-asal').value;
            input.value = qtyAsal;
            input.setAttribute('readonly', true); // Kunci input
        } else {
            input.value = '';
            input.removeAttribute('readonly'); // Buka kunci
        }
    });
}

// 7. PROSES SIMPAN KE DATABASE
function prosesSimpanRetur() {
    const idTrx = document.getElementById('retur-id-trx').value;
    const jenis = document.getElementById('retur-jenis-trx').value;
    const alasan = document.getElementById('retur-alasan').value;
    
    let itemsToReturn = [];
    let hasInput = false;

    const rows = document.querySelectorAll('.item-retur-row');
    rows.forEach(row => {
        const prod = row.querySelector('.data-produk').value;
        const tipe = row.querySelector('.data-tipe').value;
        const harga = row.querySelector('.data-harga').value;
        const qtyInput = row.querySelector('.input-qty-retur').value;
        const qtyRetur = Number(qtyInput);

        if(qtyRetur > 0) hasInput = true;
        
        itemsToReturn.push({
            produk: prod,
            tipe: tipe,
            hargaSatuan: harga,
            qtyRetur: qtyRetur
        });
    });

    if(!hasInput) return myAlert('Error', 'Masukkan jumlah barang yang ingin diretur!', 'error');

    const payload = {
        idTrx: idTrx,
        jenis: jenis, // 'JUAL' atau 'BELI'
        alasan: alasan,
        items: itemsToReturn
    };
    
    // Kirim ke Backend
    myConfirm('Konfirmasi Retur', 'Stok akan disesuaikan. Lanjutkan?', () => {
        loading(true);
        google.script.run.withSuccessHandler(res => {
            loading(false);
            bootstrap.Modal.getInstance(document.getElementById('modalFormRetur')).hide();
            myAlert('Sukses', res, 'success');
            // Refresh tabel yang sesuai
            if(jenis === 'JUAL') loadRiwayatJual();
            else loadRiwayatBeli();
        }).prosesReturBaru(payload);
    });
}

  // --- PEMBELIAN ---
  function loadPembelianData() {
    google.script.run.withSuccessHandler(d => {
       const s = document.getElementById('beli-supplier'); s.innerHTML=''; d.forEach(r=>s.innerHTML+=`<option>${r[1]}</option>`);
    }).getData('SUPPLIER');
  }
  function simpanSupplier() {
    google.script.run.withSuccessHandler(()=>{ bootstrap.Modal.getInstance(document.getElementById('modalSupplier')).hide(); loadPembelianData(); }).tambahSupplier({nama:document.getElementById('sup-nama').value, hp:document.getElementById('sup-hp').value, alamat:document.getElementById('sup-alamat').value});
  }
  function updateHargaBeli() {
    const sel = document.getElementById('beli-produk');
    const price = sel.options[sel.selectedIndex]?.getAttribute('data-buy') || 0;
    const qty = document.getElementById('beli-qty').value;
    document.getElementById('beli-harga').value = price;
    document.getElementById('beli-total').innerText = rupiah(price * qty);
  }
  function prosesBeli() {
    const d = { supplier: document.getElementById('beli-supplier').value, produk: document.getElementById('beli-produk').value, qty: document.getElementById('beli-qty').value, total: document.getElementById('beli-harga').value * document.getElementById('beli-qty').value, metode:'Tunai', isTukar: document.getElementById('beli-tukar').checked };
    if(confirm('Simpan Beli?')) {
        loading(true);
        google.script.run.withSuccessHandler(()=>{ 
            loading(false);
            alert('Sukses'); 
            loadProduk(); 
        }).simpanPembelian(d);
    }
  }

function loadPelanggan() {
    loading(true);
    google.script.run.withSuccessHandler(data => {
      loading(false);

      // --- PENGAMAN ---
      if (!data) return;

      const tb = document.querySelector('#tabel-pelanggan tbody');
      tb.innerHTML = '';
      data.forEach(r => {
        tb.innerHTML += `
          <tr>
            <td class="fw-bold">${r[1]}</td>
            <td>${r[2]}</td>
            <td>${r[3]}<br><small class="text-muted">${r[4]}</small></td>
            <td>
               <button class="btn btn-sm btn-warning" onclick="editPelanggan('${r[0]}','${r[1]}','${r[2]}','${r[3]}','${r[4]}')"><i class="material-icons" style="font-size:14px">edit</i></button>
               <button class="btn btn-sm btn-danger" onclick="hapusPelanggan('${r[0]}')"><i class="material-icons" style="font-size:14px">delete</i></button>
            </td>
          </tr>`;
      });
    }).getData('PELANGGAN');
  }

  // Handle Modal (Bisa dari menu Pelanggan, bisa dari shortcut Kasir)
  let isFromKasir = false; 

  function modalPelanggan(fromKasir = false) {
    isFromKasir = fromKasir;
    document.getElementById('pel-id').value = '';
    document.getElementById('pel-nama').value = '';
    document.getElementById('pel-pt').value = '';
    document.getElementById('pel-hp').value = '';
    document.getElementById('pel-alamat').value = '';
    new bootstrap.Modal(document.getElementById('modalPelanggan')).show();
  }

  function editPelanggan(id, nama, pt, hp, alamat) {
    document.getElementById('pel-id').value = id;
    document.getElementById('pel-nama').value = nama;
    document.getElementById('pel-pt').value = pt;
    document.getElementById('pel-hp').value = hp;
    document.getElementById('pel-alamat').value = alamat;
    new bootstrap.Modal(document.getElementById('modalPelanggan')).show();
  }

  function simpanPelangganDB() {
    const d = {
      id: document.getElementById('pel-id').value,
      nama: document.getElementById('pel-nama').value,
      pt: document.getElementById('pel-pt').value,
      hp: document.getElementById('pel-hp').value,
      alamat: document.getElementById('pel-alamat').value
    };

    if(!d.nama) return alert('Nama wajib diisi!');

    loading(true);
    google.script.run.withSuccessHandler(res => {
       loading(false);
       alert(res);
       bootstrap.Modal.getInstance(document.getElementById('modalPelanggan')).hide();
       
       if(isFromKasir) {
          // Jika input dari kasir, refresh dropdown kasir
          loadPelangganDropdown(); 
       } else {
          // Jika dari menu admin, refresh tabel
          loadPelanggan();
       }
    }).simpanPelanggan(d);
  }

function hapusPelanggan(id) {
    myConfirm('Hapus Pelanggan', 'Apakah Anda yakin ingin menghapus data pelanggan ini?', () => {
       loading(true);
       google.script.run.withSuccessHandler(() => {
         loading(false);
         loadPelanggan();
         myAlert('Sukses', 'Data Pelanggan berhasil dihapus', 'success');
       }).hapusPelanggan(id);
    });
  }

  function filterPelanggan() {
    const k = document.getElementById('cari-pelanggan').value.toLowerCase();
    document.querySelectorAll('#tabel-pelanggan tbody tr').forEach(tr => {
       tr.style.display = tr.innerText.toLowerCase().includes(k) ? '' : 'none';
    });
  }

  // --- INTEGRASI KE KASIR ---
  
function loadPelangganDropdown() {
    // Jangan loading(true) agar tidak mengganggu UI
    google.script.run.withSuccessHandler(data => {
       // --- PENGAMAN: Cek jika data kosong/null ---
       if (!data) return; 

       const sel = document.getElementById('kasir-pelanggan');
       const currentVal = sel.value; 
       
       sel.innerHTML = '<option value="Umum">Umum</option>';
       
       data.forEach(r => {
          let label = r[1]; 
          if(r[2]) label = `${r[2]} (${r[1]})`; 
          sel.innerHTML += `<option value="${label}">${label}</option>`;
       });

       if(currentVal) sel.value = currentVal;

    }).getListPelanggan();
  }

  // --- KEUANGAN ---
  function loadKeuangan() {
    loading(true);
    google.script.run.withSuccessHandler(d => {
      loading(false);
      const tb = document.querySelector('#tabel-keuangan tbody'); tb.innerHTML='';
      d.reverse().slice(0,10).forEach(r => tb.innerHTML+=`<tr><td>${new Date(r[1]).toLocaleDateString()}</td><td>${r[2]}</td><td>${r[3]}</td><td>${rupiah(r[4])}</td><td>${r[5]}</td></tr>`);
    }).getData('KEUANGAN');
  }
  function bukaModalKeuangan() {
    new bootstrap.Modal(document.getElementById('modalKeuangan')).show();
    google.script.run.withSuccessHandler(c => { const s=document.getElementById('keu-kategori'); s.innerHTML=''; c.forEach(x=>s.innerHTML+=`<option>${x}</option>`); }).getKategori();
  }
  function tambahKategoriBaru() { const n = prompt('Nama Kategori?'); if(n) google.script.run.tambahKategori(n); }
  function simpanKeuangan() {
    const d = { jenis: document.getElementById('keu-jenis').value, kategori: document.getElementById('keu-kategori').value, nominal: document.getElementById('keu-nominal').value, keterangan: document.getElementById('keu-ket').value };
    loading(true);
    google.script.run.withSuccessHandler(()=>{ 
        loading(false);
        bootstrap.Modal.getInstance(document.getElementById('modalKeuangan')).hide(); 
        loadKeuangan(); 
    }).simpanKeuangan(d);
  }

  // --- PAYROLL (TABS) ---
  function switchTab(t) {
    document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('d-none')); document.getElementById('tab-'+t).classList.remove('d-none');
    document.querySelectorAll('#payrollTabs .nav-link').forEach(e=>e.classList.remove('active')); event.target.classList.add('active');
    if(t==='karyawan') loadKaryawan();
    if(t==='kasbon') loadKasbon();
  }

  function loadKaryawan() {
    google.script.run.withSuccessHandler(d => {
      const tb = document.querySelector('#tabel-karyawan tbody'); const sk = document.getElementById('kasbon-nama');
      tb.innerHTML=''; sk.innerHTML='';
      d.forEach(r => {
        tb.innerHTML+=`<tr><td>${r[1]}</td><td>${r[2]}</td><td>${rupiah(r[3])}</td><td>${rupiah(r[4])}</td><td><button class="btn btn-sm btn-danger" onclick="hapusKaryawan('${r[0]}')">X</button></td></tr>`;
        sk.innerHTML+=`<option>${r[1]}</option>`;
      });
    }).getData('KARYAWAN');
  }
  function modalKaryawan() { document.getElementById('kry-id').value=''; new bootstrap.Modal(document.getElementById('modalKaryawan')).show(); }
  function simpanKaryawanDB() {
    const d = { id: document.getElementById('kry-id').value, nama: document.getElementById('kry-nama').value, hp: document.getElementById('kry-hp').value, gaji: document.getElementById('kry-gaji').value, bonus: document.getElementById('kry-bonus').value };
    google.script.run.withSuccessHandler(()=>{ bootstrap.Modal.getInstance(document.getElementById('modalKaryawan')).hide(); loadKaryawan(); }).simpanKaryawan(d);
  }
  function hapusKaryawan(id) { if(confirm('Hapus?')) google.script.run.withSuccessHandler(loadKaryawan).hapusKaryawan(id); }

  function loadKasbon() {
    google.script.run.withSuccessHandler(d => {
      const tb = document.querySelector('#tabel-kasbon tbody'); tb.innerHTML='';
      d.filter(x=>x[5]==='Belum Lunas').forEach(r => tb.innerHTML+=`<tr><td>${new Date(r[1]).toLocaleDateString()}</td><td>${r[2]}</td><td class="text-danger">${rupiah(r[3])}</td></tr>`);
    }).getData('KASBON');
  }
  function simpanKasbon() {
    google.script.run.withSuccessHandler(()=>{ alert('Kasbon OK'); loadKasbon(); }).simpanKasbon({nama:document.getElementById('kasbon-nama').value, nominal:document.getElementById('kasbon-nominal').value, ket:document.getElementById('kasbon-ket').value});
  }

  function loadHitungGaji() {
    document.querySelector('#tabel-hitung-gaji tbody').innerHTML='Loading...';
    google.script.run.withSuccessHandler(d => {
      payrollDataTemp = d; const tb = document.querySelector('#tabel-hitung-gaji tbody'); tb.innerHTML='';
      d.forEach(p => tb.innerHTML+=`<tr><td>${p.nama}</td><td>${rupiah(p.gaji)}</td><td>${rupiah(p.bonus)}</td><td class="text-danger">${rupiah(p.kasbon)}</td><td class="fw-bold">${rupiah(p.total)}</td></tr>`);
    }).getDataPayroll();
  }
  function cairkanGaji() {
    if(confirm('Cairkan Gaji? Kasbon akan dianggap Lunas.')) google.script.run.withSuccessHandler(alert).prosesPayrollFinal(payrollDataTemp);
  }

  // --- HELPER: SET TANGGAL OTOMATIS (1 sd Hari Ini) ---
function setAutoDate(tipe) {
    const now = new Date();
    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1); // Tanggal 1 Bulan Ini

    // Fungsi Format ke YYYY-MM-DD (Waktu Lokal Indonesia)
    const toStr = (d) => {
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };

    // Set ke Input HTML
    const elStart = document.getElementById(`filter-${tipe}-start`);
    const elEnd = document.getElementById(`filter-${tipe}-end`);

    if(elStart) elStart.value = toStr(firstDay);
    if(elEnd) elEnd.value = toStr(now);
}

// Listener untuk Metode Bayar
document.getElementById('pos-metode-bayar').addEventListener('change', function() {
    const val = this.value;
    const box = document.getElementById('box-jatuh-tempo');
    
    if(val === 'Hutang') {
        box.classList.remove('d-none'); // Munculkan tanggal
        // Set default jatuh tempo: 7 hari dari sekarang
        const nextWeek = new Date();
        nextWeek.setDate(nextWeek.getDate() + 7);
        document.getElementById('pos-jatuh-tempo').value = nextWeek.toISOString().split('T')[0];
    } else {
        box.classList.add('d-none'); // Sembunyikan
    }
});

// --- FITUR PIUTANG ---

// 1. Load Data Piutang saat menu diklik
// (Tambahkan ini di dalam fungsi showPage, di bagian blok IF nya)
// if(pageId === 'riwayat-piutang') loadPiutang(); 

function loadPiutang() {
   loading(true);
   google.script.run.withSuccessHandler(data => {
      loading(false);
      const tb = document.querySelector('#tabel-piutang tbody');
      tb.innerHTML = '';
      
      if(!data || data.length === 0) {
         tb.innerHTML = '<tr><td colspan="4" class="text-center text-muted p-4">Tidak ada data hutang yang belum lunas.</td></tr>';
         return;
      }

      data.forEach(row => {
         // row: [ID, Waktu, Pelanggan, Total, JatuhTempo]
         let tglTempo = new Date(row[4]).toLocaleDateString('id-ID');
         let tglTrx = new Date(row[1]).toLocaleDateString('id-ID');
         
         // Cek jika sudah lewat jatuh tempo (warna merah)
         let isLate = new Date(row[4]) < new Date();
         let tempoStyle = isLate ? 'text-danger fw-bold' : 'text-dark';
         let badgeLate = isLate ? '<span class="badge bg-danger">Lewat Jatuh Tempo</span>' : '';

         tb.innerHTML += `
           <tr>
              <td>
                 <div class="${tempoStyle}">${tglTempo}</div>
                 ${badgeLate}
                 <small class="text-muted d-block">Trx: ${tglTrx}</small>
              </td>
              <td>
                 <span class="fw-bold">${row[2]}</span><br>
                 <small class="text-muted text-truncate d-block" style="max-width:200px">ID: ${row[0]}</small>
              </td>
              <td class="fw-bold fs-5 text-danger">${rupiah(row[3])}</td>
              <td>
                 <button class="btn btn-success btn-sm rounded-pill px-3 fw-bold" onclick="prosesPelunasan('${row[0]}', '${row[2]}', ${row[3]})">
                    <i class="material-icons align-middle" style="font-size:16px">payments</i> LUNASI
                 </button>
              </td>
           </tr>
         `;
      });
   }).getDataPiutang();
}

function prosesPelunasan(id, nama, total) {
    myConfirm('Pelunasan Hutang', `Terima pembayaran sebesar ${rupiah(total)} dari ${nama}?\n\nData akan dicatat ke KEUANGAN (Pemasukan) dan status transaksi menjadi LUNAS.`, () => {
        loading(true);
        google.script.run.withSuccessHandler(res => {
            loading(false);
            myAlert('Berhasil', res, 'success');
            loadPiutang();      // Refresh tabel piutang
            loadDashboard();    // Update uang di dashboard
            loadNotifHutang();  // Update lonceng notifikasi
        }).lunasiHutang(id, total, nama);
    });
}
</script>
